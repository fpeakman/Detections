# ManualFinder/PDF Editor Malware Campaign

|Idea / Hypothesis|Tactic|Notes|
|---|---|---|
|Legitimate looking PDF etc software can be malicious||Copied directly from [LindenSec](https://www.lindensec.com/post/detecting-manualfinder-pdf-editor-malware-campaign-with-kql)|

## Why

- Licenses for PDF editor software can be expensive leading to users seeking out other solutions
- When a product is "free", most of the time the user is the product. Hence these are PUP's
- PUPs can be abused to steal information and more. 

### KQL

```KQL
// External IOC Data Sources
let FileHashes = externaldata(Hash: string)
[@"https://raw.githubusercontent.com/LindenSec/IoC/refs/heads/main/PDFEditorManualFinder/hashes.txt"]
with (format="txt", ignoreFirstRecord=false);
let C2Domains = externaldata(Domain: string)
[@"https://raw.githubusercontent.com/LindenSec/IoC/refs/heads/main/PDFEditorManualFinder/c2.txt"]
with (format="txt", ignoreFirstRecord=false);
let PDFDomains = externaldata(Domain: string)
[@"https://raw.githubusercontent.com/LindenSec/IoC/refs/heads/main/PDFEditorManualFinder/domains.txt"]
with (format="txt", ignoreFirstRecord=false);
let SuspiciousSigners = externaldata(Signer: string)
[@"https://raw.githubusercontent.com/LindenSec/IoC/refs/heads/main/PDFEditorManualFinder/signers.txt"]
with (format="txt", ignoreFirstRecord=false);
let MaliciousCommands = externaldata(Command: string)
[@"https://raw.githubusercontent.com/LindenSec/IoC/refs/heads/main/PDFEditorManualFinder/commands.txt"]
with (format="txt", ignoreFirstRecord=false);
// Static IOCs that remain consistent across samples
let SuspiciousFileDescriptions = dynamic([
    "PDF EDITOR BY APPSUITE"
]);
let SuspiciousCompanyNames = dynamic([
    "AppSuite"
]);
// Convert external data to arrays for efficient lookups (filtered for non-empty values)
let HashList = toscalar(FileHashes | where isnotempty(Hash) and Hash != "" | summarize make_list(Hash));
let C2DomainList = toscalar(C2Domains | where isnotempty(Domain) and Domain != "" | summarize make_list(Domain));
let PDFDomainList = toscalar(PDFDomains | where isnotempty(Domain) and Domain != "" | summarize make_list(Domain));
let SignerList = toscalar(SuspiciousSigners | where isnotempty(Signer) and Signer != "" | summarize make_list(Signer));
let CommandList = toscalar(MaliciousCommands | where isnotempty(Command) and Command != "" | summarize make_list(Command));
// Hunt across multiple data sources
union (
    // Hunt in Device File Events for hash matches
    DeviceFileEvents
    | where TimeGenerated >= ago(30d)
    | where SHA256 in (HashList) or SHA1 in (HashList) or MD5 in (HashList)
    | extend IOCType = "File Hash Match"
    | project TimeGenerated, DeviceName, InitiatingProcessAccountName, FileName, FolderPath, SHA256, SHA1, MD5, IOCType
),
(
    // Hunt in Device Process Events for hash matches
    DeviceProcessEvents  
    | where TimeGenerated >= ago(30d)
    | where SHA256 in (HashList) or SHA1 in (HashList) or MD5 in (HashList)
    | extend IOCType = "Process Hash Match"
    | project TimeGenerated, DeviceName, InitiatingProcessAccountName, ProcessCommandLine, FileName, FolderPath, SHA256, SHA1, MD5, IOCType
),
(
    // Hunt for suspicious signers using DeviceFileCertificateInfo
    DeviceFileCertificateInfo
    | where TimeGenerated >= ago(30d)
    | where Signer in (SignerList)
    | join kind=inner (
        DeviceFileEvents
        | where TimeGenerated >= ago(30d)
    ) on SHA1
    | extend IOCType = "Suspicious Certificate Signer"
    | project TimeGenerated, DeviceName, InitiatingProcessAccountName, FileName, FolderPath, Signer, SHA256, SHA1, IOCType
),
(
    // Hunt for suspicious company names in version info
    DeviceFileEvents
    | where TimeGenerated >= ago(30d)
    | where InitiatingProcessVersionInfoCompanyName in (SuspiciousCompanyNames)
    | extend IOCType = "Suspicious Company Name"
    | project TimeGenerated, DeviceName, InitiatingProcessAccountName, FileName, FolderPath, InitiatingProcessVersionInfoCompanyName, SHA256, IOCType
),
(
    // Hunt for suspicious file descriptions in version info
    DeviceProcessEvents
    | where TimeGenerated >= ago(30d)
    | where InitiatingProcessVersionInfoFileDescription in (SuspiciousFileDescriptions)
    | extend IOCType = "Suspicious File Description"
    | project TimeGenerated, DeviceName, InitiatingProcessAccountName, ProcessCommandLine, FileName, FolderPath, InitiatingProcessVersionInfoFileDescription, SHA256, IOCType
),
(
    // Hunt for malicious commands in process events using GitHub command list
    DeviceProcessEvents
    | where TimeGenerated >= ago(30d)
    | where ProcessCommandLine has_any (CommandList)
    | extend IOCType = "Malicious Command Execution"
    | project TimeGenerated, DeviceName, InitiatingProcessAccountName, ProcessCommandLine, InitiatingProcessFileName, SHA256, IOCType
),
(
    // Hunt for network connections to malicious domains
    DeviceNetworkEvents
    | where TimeGenerated >= ago(30d) 
    | where RemoteUrl has_any (C2DomainList) or RemoteUrl has_any (PDFDomainList) or
            RemoteIP has_any (C2DomainList) or RemoteIP has_any (PDFDomainList)
    | extend IOCType = "Malicious Domain Connection"
    | project TimeGenerated, DeviceName, InitiatingProcessAccountName, InitiatingProcessFileName, RemoteUrl, RemoteIP, RemotePort, IOCType
),
(
    // Hunt in DNS queries
    DeviceEvents
    | where TimeGenerated >= ago(30d)
    | where ActionType == "DnsQueryResponse"
    | extend DnsQuery = tostring(parse_json(AdditionalFields).DnsQueryName)
    | where DnsQuery has_any (C2DomainList) or DnsQuery has_any (PDFDomainList)
    | extend IOCType = "Malicious DNS Query"
    | project TimeGenerated, DeviceName, InitiatingProcessAccountName, DnsQuery, IOCType
)
| summarize 
    FirstActivity = min(TimeGenerated),
    LastActivity = max(TimeGenerated),
    TotalAlerts = count(),
    IOCTypes = make_set(IOCType),
    UniqueUsers = make_set(InitiatingProcessAccountName),
    SampleCommands = make_set_if(ProcessCommandLine, isnotempty(ProcessCommandLine), 3),
    SampleFiles = make_set_if(FileName, isnotempty(FileName), 5),
    MaliciousDomains = make_set_if(RemoteUrl, isnotempty(RemoteUrl), 5),
    DNSQueries = make_set_if(DnsQuery, isnotempty(DnsQuery), 5),
    FileHashes = make_set_if(SHA256, isnotempty(SHA256), 5)
    by DeviceName
| extend 
    RiskScore = case(
        array_length(IOCTypes) >= 4, "CRITICAL",
        array_length(IOCTypes) >= 3, "HIGH", 
        array_length(IOCTypes) >= 2, "MEDIUM",
        "LOW"
    ),
    ActivitySpan = LastActivity - FirstActivity
| project 
    DeviceName,
    RiskScore,
    TotalAlerts,
    FirstActivity,
    LastActivity,
    ActivitySpan,
    IOCTypes,
    UniqueUsers,
    SampleCommands,
    SampleFiles,
    MaliciousDomains,
    DNSQueries,
    FileHashes
| sort by 
    case(RiskScore == "CRITICAL", 1, RiskScore == "HIGH", 2, RiskScore == "MEDIUM", 3, 4) asc,
    TotalAlerts desc